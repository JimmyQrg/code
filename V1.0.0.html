<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Free Online</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/htmlmixed/htmlmixed.min.js"></script>

<style>
body {
    margin:0; font-family:'Press Start 2P', monospace; background:#0b0b0b; display:flex; flex-direction:column; height:100vh;
}
header { text-align:center; padding:15px; }
header h1 { color:#ffffff; text-shadow:0 0 15px #00fffa,0 0 30px #00fffa; margin:0; }

#controls { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px; }
select, button, input[type="file"] { padding:10px; font-size:12px; border:none; border-radius:6px; background:#111; color:#fff; cursor:pointer; }
select:hover, button:hover, input[type="file"]:hover { background:#00aaff; color:#0b0b0b; }

#run { width:40px; height:40px; display:flex; justify-content:center; align-items:center; position:relative; }
#run::before { content:''; border-style:solid; border-width:10px 0 10px 16px; border-color:transparent transparent transparent #ffffff; }
#run.running::before { content:''; width:16px; height:16px; background-color:#ff0044; }

#main { display:flex; flex:1; overflow:hidden; gap:10px; padding:10px; }
#editor-container { flex:1; display:flex; flex-direction:column; }

#tabs { display:flex; gap:5px; margin-bottom:5px; overflow-x:auto; }
.tab { background:#111; padding:5px 10px; border-radius:5px 5px 0 0; cursor:pointer; color:#fff; white-space:nowrap; }
.tab.active { background:#00ffff; color:#000; font-weight:bold; text-shadow:0 0 6px #00ffff; }

.CodeMirror { height:100%; border:2px solid #fff; border-radius:8px; font-size:14px; caret-color:#fff; }
.cm-s-cyber { background:#0a0a0a; color:#fff; caret-color:#fff; }
.cm-s-cyber .cm-comment { color:#b0b0b0; font-style:italic; }
.cm-s-cyber .cm-string { color:#ffa040; text-shadow:0 0 2px #ffa040; }
.cm-s-cyber .cm-keyword { color:#00d0ff; font-weight:bold; text-shadow:0 0 4px #00d0ff; }
.cm-s-cyber .cm-number { color:#ffff00; }
.cm-s-cyber .cm-variable { color:#fff; }
.cm-s-cyber .cm-def { color:#c080ff; font-weight:bold; text-shadow:0 0 3px #c080ff; }
.cm-s-cyber .cm-bracket, .cm-s-cyber .cm-paren { color:#fff; font-weight:bold; }

.CodeMirror-cursor { border-left:2px solid #fff !important; animation: blink 1s step-end infinite; }
@keyframes blink { 0%,50% { border-color:#fff; } 50.1%,100% { border-color:transparent; } }
.CodeMirror-activeline-background { background:#111; }
.CodeMirror pre { white-space: pre-wrap !important; word-wrap: break-word; overflow-wrap: break-word; } /* wraps inside strings */

#output-container { flex:1; display:flex; flex-direction:column; gap:10px; }
#output { flex:1; border:2px solid #fff; border-radius:8px; background:#0a0a0a; overflow:auto; padding:10px; white-space:pre-wrap; font-size:13px; color:#fff; }
#htmlPreview { flex:1; border:2px solid #ccc; border-radius:8px; background:#fff; width:100%; height:100%; overflow:auto; display:none; }
</style>
</head>
<body>

<header><h1>Code Free Online</h1></header>

<div id="controls">
    <select id="language" onchange="changeMode()">
        <option value="python3">Python 3</option>
        <option value="cpp">C++</option>
        <option value="c">C</option>
        <option value="csharp">C#</option>
        <option value="java">Java</option>
        <option value="html">HTML</option>
        <option value="javascript">JavaScript</option>
        <option value="ruby">Ruby</option>
        <option value="go">Go</option>
        <option value="php">PHP</option>
        <option value="swift">Swift</option>
        <option value="rust">Rust</option>
        <option value="kotlin">Kotlin</option>
    </select>
    <button id="run" onclick="toggleRun()"></button>
    <button onclick="downloadCode()">Download</button>
    <input type="file" id="importFile" accept=".py,.cpp,.c,.cs,.java,.html,.js,.rb,.go,.php,.swift,.rs,.kt,.txt" onchange="importFile()">
</div>

<div id="main">
    <div id="editor-container">
        <div id="tabs"></div>
        <textarea id="editor">// Write your code here</textarea>
    </div>
    <div id="output-container">
        <pre id="output">Output will appear here...</pre>
        <iframe id="htmlPreview"></iframe>
    </div>
</div>

<script>
// Tabs & Multi-file
let tabs = [];
let activeTab = null;
function addTab(name="newFile.py", lang="python3", content="// Write your code here"){
    const tab = {name, lang, content};
    tabs.push(tab);
    renderTabs();
    switchTab(tab);
}
function renderTabs(){
    const tabsDiv = document.getElementById('tabs');
    tabsDiv.innerHTML = "";
    tabs.forEach(tab=>{
        const div=document.createElement('div'); div.className="tab"; div.textContent=tab.name;
        if(tab===activeTab) div.classList.add('active');
        div.onclick=()=>switchTab(tab);
        tabsDiv.appendChild(div);
    });
}
function switchTab(tab){
    if(activeTab) activeTab.content = activeTab.editorValue || editor.getValue();
    activeTab = tab;
    editor.setValue(tab.content);
    document.getElementById('language').value = tab.lang;
    changeMode();
    renderTabs();
}

// Initialize CodeMirror
let editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
    lineNumbers: true,
    mode: 'python',
    theme: 'cyber',
    indentUnit: 2,
    tabSize: 2,
    autoCloseBrackets: true,
    matchBrackets: true,
    styleActiveLine: true,
    lineWrapping: true,
});
editor.setOption("extraKeys", {
    Tab: cm=>cm.replaceSelection("  "),
    Enter: function(cm){
        let pos=cm.getCursor(); let line=cm.getLine(pos.line);
        if(line.trim().endsWith(":")||line.trim().endsWith("{")) cm.replaceSelection("\n  ");
        else cm.replaceSelection("\n");
    }
});
editor.on("change", function(cm, change){
    if(change.origin!==' +input') return;
    const lines=cm.getValue().split("\n");
    if(lines.length>=2){ const lastTwo=lines.slice(-2); if(lastTwo[0].trim()===""&&lastTwo[1].trim()==="") cm.replaceRange("}", {line:lines.length-1,ch:0}); }
});

// Language & Mode
function changeMode(){
    const lang=document.getElementById('language').value;
    const cmModeMap={python3:'python', cpp:'text/x-c++src', c:'text/x-csrc', csharp:'text/x-csharp',
                     java:'text/x-java', html:'htmlmixed', javascript:'javascript', ruby:'ruby',
                     go:'go', php:'php', swift:'swift', rust:'rust', kotlin:'text/x-kotlin'};
    editor.setOption('mode', cmModeMap[lang]||'text');
    const htmlPreview = document.getElementById('htmlPreview');
    htmlPreview.style.display=(lang==='html')?'block':'none';
    if(lang==='html') updateHTMLPreview();
}
function updateHTMLPreview(){ document.getElementById('htmlPreview').srcdoc=editor.getValue(); }
editor.on('change', ()=>{ if(document.getElementById('language').value==='html') updateHTMLPreview(); });

// Import & Run
function importFile(){ const file=document.getElementById('importFile').files[0]; if(!file)return; if(file.size>3*1024*1024*1024){alert("File too large");return;}
const reader=new FileReader(); reader.onload=e=>{activeTab.content=e.target.result; editor.setValue(activeTab.content);}; reader.readAsText(file); }

let running=false; let currentRequest=null;
function toggleRun(){ if(!running) runCode(); else{ if(currentRequest)currentRequest.abort(); running=false; setRunButton(false); document.getElementById('output').textContent+="\nExecution stopped."; } }
function setRunButton(isRunning){ const btn=document.getElementById('run'); running=isRunning; if(isRunning) btn.classList.add('running'); else btn.classList.remove('running'); }

async function runCode(){
    setRunButton(true);
    const language=document.getElementById('language').value;
    const code=editor.getValue();
    const outputEl=document.getElementById('output'); outputEl.textContent="Running...\n";
    if(language==='html'){ updateHTMLPreview(); outputEl.textContent="HTML preview updated."; setRunButton(false); return; }
    const langMap={python3:"python", cpp:"cpp", c:"c", csharp:"csharp", java:"java",
                   javascript:"javascript", ruby:"ruby", go:"go", php:"php", swift:"swift",
                   rust:"rust", kotlin:"kotlin"};
    const controller=new AbortController(); currentRequest=controller;
    try{
        const response=await fetch('https://emkc.org/api/v2/piston/execute',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({language:langMap[language]||"python", version:"*", files:[{name:"code."+getExtension(language), content:code}]}),
            signal:controller.signal
        });
        const data=await response.json();
        outputEl.textContent=data.run?.output || "No output";
    } catch(err){ outputEl.textContent=(err.name==='AbortError')?"Execution aborted.":"Error: "+err.message; }
    setRunButton(false);
}

function downloadCode(){ const code=editor.getValue(); const lang=document.getElementById('language').value; const blob=new Blob([code],{type:'text/plain'});
const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`code.${getExtension(lang)}`; a.click(); URL.revokeObjectURL(url); }
function getExtension(lang){ const map={python3:"py", cpp:"cpp", c:"c", csharp:"cs", java:"java", html:"html", javascript:"js", ruby:"rb", go:"go", php:"php", swift:"swift", rust:"rs", kotlin:"kt"}; return map[lang]||"txt"; }

// Add initial tab
addTab("main.py","python3","print('Hello World')");
</script>
</body>
</html>
