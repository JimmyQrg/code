<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Free Online</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/htmlmixed/htmlmixed.min.js"></script>

<style>
/* ===== BODY ===== */
body {
    margin: 0;
    font-family: 'Press Start 2P', monospace;
    background-color: #0b0b0b;
    color: #00fffa;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
}

/* ===== HEADER ===== */
header {
    text-align: center;
    padding: 15px;
}
header h1 {
    color: #00fffa;
    text-shadow: 0 0 15px #00fffa, 0 0 30px #00fffa;
    margin: 0;
}

/* ===== CONTROLS ===== */
#controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    padding: 10px;
}
select, button, input[type="file"] {
    padding: 10px;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    background-color: #111;
    color: #00fffa;
    cursor: pointer;
    transition: 0.2s;
}
select:hover, button:hover, input[type="file"]:hover {
    background-color: #00aabb;
    color: #000;
}
#run {
    width: 40px;
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}
#run::before {
    content: '';
    border-style: solid;
    border-width: 10px 0 10px 16px;
    border-color: transparent transparent transparent #00fffa;
}
#run.running::before {
    content: '';
    width: 16px;
    height: 16px;
    background-color: #ff0044;
}

/* ===== MAIN AREA SPLIT ===== */
#main {
    display: flex;
    flex: 1;
    overflow: hidden;
    padding: 10px;
    gap: 10px;
}

/* ===== EDITOR ===== */
#editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.CodeMirror {
    height: 100%;
    border: 2px solid #00fffa;
    border-radius: 8px;
    background: #0a0a0a;
    color: #f0f0f0; /* light code color */
    font-size: 14px;
}

/* ===== OUTPUT ===== */
#output-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
#output, #htmlPreview {
    flex: 1;
    border: 2px solid #00fffa;
    border-radius: 8px;
    background-color: #0a0a0a;
    overflow-y: auto;
    padding: 10px;
    white-space: pre-wrap;
    font-size: 13px;
    color: #f0f0f0;
}
#htmlPreview { display: none; }
</style>
</head>
<body>

<header>
    <h1>Code Free Online</h1>
</header>

<div id="controls">
    <select id="language" onchange="changeMode()">
        <option value="python3">Python 3</option>
        <option value="cpp">C++</option>
        <option value="c">C</option>
        <option value="csharp">C#</option>
        <option value="java">Java</option>
        <option value="html">HTML</option>
        <option value="javascript">JavaScript</option>
        <option value="ruby">Ruby</option>
        <option value="go">Go</option>
        <option value="php">PHP</option>
        <option value="swift">Swift</option>
        <option value="rust">Rust</option>
        <option value="kotlin">Kotlin</option>
    </select>
    <button id="run" onclick="toggleRun()"></button>
    <button onclick="downloadCode()">Download</button>
    <input type="file" id="importFile" accept=".py,.cpp,.c,.cs,.java,.html,.js,.rb,.go,.php,.swift,.rs,.kt,.txt" onchange="importFile()">
</div>

<div id="main">
    <div id="editor-container">
        <textarea id="editor">// Write your code here</textarea>
    </div>
    <div id="output-container">
        <pre id="output">Output will appear here...</pre>
        <iframe id="htmlPreview"></iframe>
    </div>
</div>

<script>
// Initialize CodeMirror
let editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
    lineNumbers: true,
    mode: 'python',
    theme: 'default',
    indentUnit: 2,
    tabSize: 2,
    autoCloseBrackets: true,
    matchBrackets: true,
    styleActiveLine: true
});

// Override Tab -> 2 spaces
editor.setOption("extraKeys", {
    Tab: function(cm) { cm.replaceSelection("  "); },
    Enter: function(cm) {
        let pos = cm.getCursor();
        let line = cm.getLine(pos.line);
        if(line.trim().endsWith(":") || line.trim().endsWith("{")) {
            cm.replaceSelection("\n  ");
            return;
        }
        cm.replaceSelection("\n");
    }
});

// Auto-insert } after 2 empty lines
editor.on("change", function(cm, change) {
    if(change.origin !== '+input') return;
    const lines = cm.getValue().split("\n");
    if(lines.length >= 2) {
        const lastTwo = lines.slice(-2);
        if(lastTwo[0].trim() === "" && lastTwo[1].trim() === "") {
            cm.replaceRange("}", {line: lines.length-1, ch:0});
        }
    }
});

// Mode switching
function changeMode() {
    const lang = document.getElementById('language').value;
    const cmModeMap = {
        python3:'python', cpp:'text/x-c++src', c:'text/x-csrc', csharp:'text/x-csharp',
        java:'text/x-java', html:'htmlmixed', javascript:'javascript', ruby:'ruby',
        go:'go', php:'php', swift:'swift', rust:'rust', kotlin:'text/x-kotlin'
    };
    editor.setOption('mode', cmModeMap[lang]||'text');
    document.getElementById('htmlPreview').style.display = (lang==='html')?'block':'none';
    if(lang==='html') updateHTMLPreview();
}

// HTML live preview
function updateHTMLPreview() {
    document.getElementById('htmlPreview').srcdoc = editor.getValue();
}
editor.on('change', ()=>{ if(document.getElementById('language').value==='html') updateHTMLPreview(); });

// Import file
function importFile() {
    const file = document.getElementById('importFile').files[0];
    if(!file) return;
    if(file.size > 3*1024*1024*1024){ alert("File too large! Max 3GB."); return; }
    const reader = new FileReader();
    reader.onload = function(e){ editor.setValue(e.target.result); };
    reader.readAsText(file);
}

// Run / Stop
let running=false;
let currentRequest=null;
function toggleRun(){
    if(!running){ runCode(); } 
    else { if(currentRequest) currentRequest.abort(); running=false; setRunButton(false); document.getElementById('output').textContent+="\nExecution stopped."; }
}
function setRunButton(isRunning){
    const btn=document.getElementById('run'); running=isRunning;
    if(isRunning) btn.classList.add('running'); else btn.classList.remove('running');
}

async function runCode(){
    setRunButton(true);
    const language=document.getElementById('language').value;
    const code=editor.getValue();
    const outputEl=document.getElementById('output');
    outputEl.textContent="Running...\n";

    if(language==='html'){ updateHTMLPreview(); outputEl.textContent="HTML preview updated."; setRunButton(false); return; }

    const controller = new AbortController(); currentRequest=controller;
    try {
        const response = await fetch('https://emkc.org/api/v2/piston/execute', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({language: language, source: code}),
            signal: controller.signal
        });
        const data = await response.json();
        outputEl.textContent = data.run?.stdout || data.output || "No output";
    } catch(err){
        outputEl.textContent = (err.name==='AbortError') ? "Execution aborted." : "Error: "+err.message;
    }
    setRunButton(false);
}

// Download
function downloadCode(){
    const code=editor.getValue();
    const lang=document.getElementById('language').value;
    const blob=new Blob([code],{type:'text/plain'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`code.${getExtension(lang)}`; a.click();
    URL.revokeObjectURL(url);
}
function getExtension(lang){
    const map={python3:"py", cpp:"cpp", c:"c", csharp:"cs", java:"java", html:"html",
               javascript:"js", ruby:"rb", go:"go", php:"php", swift:"swift", rust:"rs", kotlin:"kt"};
    return map[lang]||"txt";
}
</script>
</body>
</html>
