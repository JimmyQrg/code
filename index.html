<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Online</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/htmlmixed/htmlmixed.min.js"></script>

<style>
body {
    margin: 0;
    font-family: 'Press Start 2P', monospace;
    background-color: #0d0d0d;
    color: #00fffa;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
}
h1 {
    color: #00fffa;
    text-shadow: 0 0 10px #00fffa, 0 0 20px #00fffa;
    margin-bottom: 20px;
}
#controls {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
select, button {
    padding: 10px;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    background-color: #111;
    color: #00fffa;
    cursor: pointer;
    transition: 0.2s;
}
select:hover, button:hover { background-color: #00aabb; color: #000; }
#run {
    width: 40px;
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
    position: relative;
}
#run::before {
    content: '';
    border-style: solid;
    border-width: 10px 0 10px 16px;
    border-color: transparent transparent transparent #00fffa;
}
#run.running::before {
    content: '';
    width: 16px;
    height: 16px;
    background-color: #ff0044;
}
.CodeMirror { border: 2px solid #00fffa; border-radius: 8px; height: 400px; background: #0a0a0a; }
#output, #htmlPreview {
    width: 90%; margin-top: 10px; border: 2px solid #00fffa; border-radius: 8px;
    background-color: #0a0a0a; overflow-y: auto; padding: 10px; font-size: 12px; white-space: pre-wrap;
}
#htmlPreview { display: none; height: 200px; }
</style>
</head>
<body>

<h1>Cyber IDE Pro</h1>
<div id="controls">
<select id="language" onchange="changeMode()">
    <option value="python3">Python 3</option>
    <option value="cpp">C++</option>
    <option value="c">C</option>
    <option value="csharp">C#</option>
    <option value="java">Java</option>
    <option value="html">HTML</option>
    <option value="javascript">JavaScript</option>
    <option value="ruby">Ruby</option>
    <option value="go">Go</option>
    <option value="php">PHP</option>
    <option value="swift">Swift</option>
    <option value="rust">Rust</option>
    <option value="kotlin">Kotlin</option>
</select>
<button id="run" onclick="toggleRun()"></button>
<button onclick="downloadCode()">Download</button>
</div>

<textarea id="editor">// Write your code here</textarea>
<pre id="output">Output will appear here...</pre>
<iframe id="htmlPreview"></iframe>

<script>
let editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
    lineNumbers: true,
    mode: 'python',
    theme: 'default',
    indentUnit: 2,
    tabSize: 2,
    autoCloseBrackets: true, // auto insert ()[]{}""
    matchBrackets: true
});

// TAB override to insert 2 spaces
editor.setOption("extraKeys", {
    Tab: function(cm) { cm.replaceSelection("  "); },
    Enter: function(cm) {
        let pos = cm.getCursor();
        let line = cm.getLine(pos.line);
        // Auto-indent after : or {
        if(line.trim().endsWith(":") || line.trim().endsWith("{")) {
            cm.replaceSelection("\n  ");
            return;
        }
        // Normal enter
        cm.replaceSelection("\n");
    }
});

// Auto-close } after 2 empty lines (simple implementation)
editor.on("change", function(cm, change) {
    if(change.origin !== '+input') return;
    const lines = cm.getValue().split("\n");
    if(lines.length >= 2) {
        const lastTwo = lines.slice(-2);
        if(lastTwo[0].trim() === "" && lastTwo[1].trim() === "") {
            cm.replaceRange("}", {line: lines.length-1, ch:0});
        }
    }
});

// HTML live preview
function changeMode() {
    const lang = document.getElementById('language').value;
    const cmModeMap = {
        python3:'python', cpp:'text/x-c++src', c:'text/x-csrc', csharp:'text/x-csharp',
        java:'text/x-java', html:'htmlmixed', javascript:'javascript', ruby:'ruby',
        go:'go', php:'php', swift:'swift', rust:'rust', kotlin:'text/x-kotlin'
    };
    editor.setOption('mode', cmModeMap[lang]||'text');
    document.getElementById('htmlPreview').style.display = (lang==='html')?'block':'none';
    if(lang==='html') updateHTMLPreview();
}
function updateHTMLPreview() {
    document.getElementById('htmlPreview').srcdoc = editor.getValue();
}
editor.on('change', ()=>{ if(document.getElementById('language').value==='html') updateHTMLPreview(); });

// RUN / STOP
let running=false;
let currentRequest=null;
function toggleRun(){
    if(!running){ runCode(); } 
    else { if(currentRequest) currentRequest.abort(); running=false; setRunButton(false); document.getElementById('output').textContent+="\nExecution stopped."; }
}
function setRunButton(isRunning){
    const btn=document.getElementById('run'); running=isRunning;
    if(isRunning) btn.classList.add('running'); else btn.classList.remove('running');
}
async function runCode(){
    setRunButton(true);
    const language=document.getElementById('language').value;
    const code=editor.getValue();
    const outputEl=document.getElementById('output');
    outputEl.textContent="Running...\n";
    if(language==='html'){ updateHTMLPreview(); outputEl.textContent="HTML preview updated."; setRunButton(false); return; }

    const controller=new AbortController(); currentRequest=controller;
    try{
        const response=await fetch('https://emkc.org/api/v2/piston/execute',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({language,source:code}),
            signal:controller.signal
        });
        const data=await response.json();
        outputEl.textContent=data.output||"No output";
    } catch(err){
        outputEl.textContent=(err.name==='AbortError')?"Execution aborted.":"Error: "+err.message;
    }
    setRunButton(false);
}

// DOWNLOAD
function downloadCode(){
    const code=editor.getValue();
    const lang=document.getElementById('language').value;
    const blob=new Blob([code],{type:'text/plain'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`code.${getExtension(lang)}`; a.click();
    URL.revokeObjectURL(url);
}
function getExtension(lang){
    const map={python3:"py", cpp:"cpp", c:"c", csharp:"cs", java:"java", html:"html",
               javascript:"js", ruby:"rb", go:"go", php:"php", swift:"swift", rust:"rs", kotlin:"kt"};
    return map[lang]||"txt";
}
</script>

</body>
</html>
